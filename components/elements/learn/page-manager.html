<dom-module is="page-manager">
	<template>
	<content></content>
	</template>
</dom-module>

<script type="text/javascript">
	function getPageItem(url, callback) {
		var request = new XMLHttpRequest();
		request.open('GET', url, true);

		request.onload = function() {
			if (request.status >= 200 && request.status < 400) {
				dp = new DOMParser();
				var parsed = dp.parseFromString(request.responseText, request.getResponseHeader('content-type'));
				callback(parsed.querySelector('page-item'));
			} else {
				console.log("Error ["+ request.status +"] retrieving " + url);
				console.log(request);
			}
		};

	    request.onload = function() {
	      if (request.status >= 200 && request.status < 400) {
	        // check on support for DOMParser 
	        // maybe consult https://developer.mozilla.org/en-US/Add-ons/Code_snippets/HTML_to_DOM
	        dp = new DOMParser(); 
	        var parsed = dp.parseFromString(request.responseText, request.getResponseHeader('content-type'));
	        callback(parsed.querySelector('page-item'));
	      } else {
	        console.log("Error ["+ request.status +"] retrieving " + url);
	        console.log(request);
	      }
	    };

		request.onerror = function() {
			console.log("Error ["+ request.status +"] retrieving " + url);
			console.log(request);
		};

		request.send();
		return request;
	}


	Polymer({
		is: "page-manager",
		listeners: {
			'page:ready': '_onPageReady',
			'page:remove': '_onPageRemove',
			'page:out': '_onPageOut'
		},
		fetchPage: function(url, caller) {

			var self = this;
			getPageItem(url,function(pageItem) {
				var clone = self.create("page-item");
				for (var i = 0; i < pageItem.attributes.length; i++) {
					clone.attributes.setNamedItem(pageItem.attributes[i].cloneNode())
				};
				var content = clone.$$('content');
				content.innerHTML = pageItem.innerHTML;
				clone.distributeContent();
				self.addPage(clone, caller);
				//self.selectPage(self.page_stack.length - 1);
			})
		},
		/**
		 * Add a polymerized 'page-item' to the pages under management.
		 * @param {[type]} url_or_element [description]
		 * @param {[type]} caller         [description]
		 */
		addPage: function(url_or_element, caller) {
			if (url_or_element.tagName == 'PAGE-ITEM') {
				this.page_stack.push({el:url_or_element, caller:caller});
				//console.log("Page stack now " + this.page_stack.length + " deep");
				this.appendChild(url_or_element);
				console.log(this.page_stack);
				this.selectPage(this.page_stack.length - 1);
				console.log(this.page_stack);
			} else {
				console.error("Invalid arguments to pageManager.addPage. First argument must be a page-item.");
			}

		},
		_onPageOut: function(e) {
			this.selectPage(e.detail.index);
		},
		_onPageRemove: function(e) {
			this.removePage(e.detail.caller);
		},
		_onPageReady: function(e) {
			if (this.page_stack.length == 0) {
				this.addPage(e.detail.caller, null);
			}
		},
		removePage: function(el) {
			//console.log("removePage");
			//console.log(el);
			this.removeChild(el);
		},

		selectPage:function(index) {
			console.log("selectPage");
			console.log("selectPage index " + index);

			var stack_depth_position = 0,
				stack_depth = 1,
				to_remove = [],
				to_page_out = [];


			for (i = 0; i < this.page_stack.length; i++) {
				if (i !== index) {
					if (i > index) {
						console.log("greater than index, will be removed");
						this.page_stack[i].el.pageOut();
						to_remove.push(i);
					} else {
						to_page_out.push(this.page_stack[i].el);
					}
					
				}
			}

			// Remove any items that were pageOuted
			for (i = 0; i < to_remove.length; i++) {
				this.page_stack.pop();
			}


			stack_depth_position = 25 / to_page_out.length;

			// PageOuts
			for (i = 0; i < to_page_out.length; i++) {
				to_page_out[i].pageOff(stack_depth_position * stack_depth, 10 - stack_depth, i, stack_depth_position);
				stack_depth++;
			}

			// after pages have transitioned, do pageOn
			console.log(this.page_stack.length)
			this.page_stack[index].el.pageOn(this.page_stack.length === 1);
		},

		getPageItem: getPageItem,

		ready: function() {
			//console.log('page-manager ready!');

			if (this.childElementCount == 1 && this.children[0].nodeName == 'PAGE-ITEM') {
				var pageItem = this.children[0];
				var self = this;
				this.addEventListener("page:add", function(e){
					var url = e.url || (e.detail && e.detail.url) || null;
					if (url) {
						self.fetchPage(url, e.target);

					}
				});

			} else {
				console.warn("page-manager expects a single child element, a page-item");
			}
		},
		properties: {

		},
		page_stack: []
	})    
</script>